<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG Chatbot Query Flow Diagram</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .mermaid {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
</head>
<body>
    <h1>RAG Chatbot Query Flow Diagram</h1>
    
    <div class="mermaid">
flowchart TB
    subgraph Frontend["ðŸ–¥ï¸ Frontend (Browser)"]
        UI["User Input: chatInput field"]
        JS["script.js: sendMessage()"]
        Display["Display Response + Sources"]
    end

    subgraph API["ðŸ”Œ API Layer"]
        FastAPI["FastAPI Server: app.py"]
        Endpoint["/api/query endpoint: @app.post"]
    end

    subgraph RAG["ðŸ§  RAG System"]
        RAGSys["rag_system.py: query()"]
        Session["Session Manager: get_conversation_history()"]
    end

    subgraph AI["ðŸ¤– AI Generation"]
        AIGen["ai_generator.py: generate_response()"]
        Claude["Claude API: Anthropic"]
        Decision{{"Tool needed? (Course-specific?)"}}
    end

    subgraph Search["ðŸ” Search Tools"]
        ToolMgr["Tool Manager: execute_tool()"]
        SearchTool["CourseSearchTool: search_tools.py"]
    end

    subgraph Vector["ðŸ“Š Vector Store"]
        VectorStore["vector_store.py: search()"]
        Embeddings["SentenceTransformer: Create embeddings"]
        ChromaDB[("ChromaDB: Vector Database")]
    end

    %% User Flow
    UI -->|"â‘  Enter query"| JS
    JS -->|"â‘¡ POST request"| FastAPI
    FastAPI -->|"â‘¢ Route to endpoint"| Endpoint
    Endpoint -->|"â‘£ Call RAG system"| RAGSys
    
    %% RAG Processing
    RAGSys -->|"â‘¤ Get history"| Session
    Session -->|"â‘¥ Context"| AIGen
    RAGSys -->|"â‘¦ Process query"| AIGen
    
    %% AI Decision Flow
    AIGen -->|"â‘§ API call"| Claude
    Claude -->|"â‘¨ Analyze query"| Decision
    
    %% Direct Response Path
    Decision -->|"General Q"| DirectResponse["â‘©a Direct Answer"]
    
    %% Tool Use Path
    Decision -->|"Course Q"| ToolMgr
    ToolMgr -->|"â‘©b Execute search"| SearchTool
    SearchTool -->|"â‘ª Query vectors"| VectorStore
    VectorStore -->|"â‘« Embed query"| Embeddings
    Embeddings -->|"â‘¬ Similarity search"| ChromaDB
    ChromaDB -->|"â‘­ Return matches"| VectorStore
    VectorStore -->|"â‘® Format results"| SearchTool
    SearchTool -->|"â‘¯ Tool results"| AIGen
    
    %% Response Generation
    DirectResponse -->|"â‘° Generate"| FinalResponse["Final Response"]
    AIGen -->|"â‘° Synthesize with results"| FinalResponse
    
    %% Return Path
    FinalResponse -->|"â‘± Return answer"| RAGSys
    RAGSys -->|"â‘² Update session"| Session
    RAGSys -->|"â‘³ Return data"| Endpoint
    Endpoint -->|"ã‰‘ JSON response"| JS
    JS -->|"ã‰’ Render markdown"| Display

    %% Styling
    classDef frontend fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef api fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef rag fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef ai fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
    classDef search fill:#fce4ec,stroke:#880e4f,stroke-width:2px
    classDef vector fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef database fill:#fff9c4,stroke:#f57f17,stroke-width:3px

    class UI,JS,Display frontend
    class FastAPI,Endpoint api
    class RAGSys,Session rag
    class AIGen,Claude,Decision ai
    class ToolMgr,SearchTool search
    class VectorStore,Embeddings vector
    class ChromaDB database
    </div>
</body>
</html>